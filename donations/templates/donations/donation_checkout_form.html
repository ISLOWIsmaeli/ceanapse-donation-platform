{% extends "base.html" %}

{% block title %}Donations Checkout | Ceanapse{% endblock %}

{% block content %}
<section class="donation-section">
  <div class="donation-container">
    <div class="donation-header">
      <h1 class="donation-title">Make a Donation Towards </h1>
      <p class="donation-subtitle">{{ project.name }}</p>
      <p class="donation-subtitle">Support ocean conservation and make a difference today.</p>
    </div>

    {% if messages %}
      {% for message in messages %}
        {% if message.tags == 'error' %}
          <p style="color:firebrick;">{{ message }}</p>
        {% endif %}
      {% endfor %}
    {% endif %}

    {% if not request.user.is_authenticated %}
      <div class="guest-login-prompt">
        <p>You are not logged in. Would you like to log in or continue as a guest?</p>
        <a href="#" class="btn btn--primary">Log In</a>
        <a href="#" class="btn btn--secondary">Continue as Guest</a>
      </div>
    {% endif %}

    <div class="project-container">
      <div class="projects">
        <p>{{ project.name }}</p>
        <p>Description: {{ project.description }}</p>

        <form class="donation-form" id="donation-form" method="post"
              action="{% url 'donations:donation-checkout' project.id %}">
          {% csrf_token %}

          <div class="form-group">
            <label for="amount" class="form-label">Donation Amount <span class="required">*</span></label>
            <div class="amount-input-wrapper">
              <span class="amount-currency">KES</span>
              <input type="number" id="amount" name="amount"
                     class="form-input form-input--amount"
                     placeholder="KES {{ min_amount|floatformat:'0' }} – {{ max_amount|floatformat:'0' }}"
                     step="0.01" min="{{ min_amount }}" max="{{ max_amount }}" required />
            </div>
            <p class="input-hint">
              Minimum donation: KES {{ min_amount|floatformat:"0" }} · Maximum donation: KES {{ max_amount|floatformat:"0" }}
            </p>
            <span class="form-error" id="amount-error"></span>
          </div>

          <div class="amount-suggestions">
            <button type="button" class="amount-btn" data-amount="500">KES 500</button>
            <button type="button" class="amount-btn" data-amount="1000">KES 1,000</button>
            <button type="button" class="amount-btn" data-amount="5000">KES 5,000</button>
            <button type="button" class="amount-btn" data-amount="10000">KES 10,000</button>
          </div>

          <div class="form-group">
            <span class="form-label">Donation Preference</span>
            <div class="choice-group" role="radiogroup" aria-label="Donation preference">
              <label class="choice-pill">
                <input type="radio" name="is_anonymous" value="false" checked />
                <span>Show my name</span>
              </label>
              <label class="choice-pill">
                <input type="radio" name="is_anonymous" value="true" />
                <span>Give anonymously</span>
              </label>
            </div>
            <p class="input-hint">
              Anonymous donations hide your name on acknowledgements, but you’ll still receive receipts via email.
            </p>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn--primary" id="submit-btn">
              <span class="btn-text">Proceed to Donate</span>
              <span class="btn-loader" id="btn-loader" style="display: none;">
                <span class="loader"></span>
              </span>
            </button>
            <a href="{% url 'projects:ceanapse-home' %}" class="btn btn--secondary">Cancel</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
  // Amount suggestion buttons
  document.querySelectorAll('.amount-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const amount = this.getAttribute('data-amount');
      document.getElementById('amount').value = amount;

      document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
    });
  });

  // Helper: get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}
