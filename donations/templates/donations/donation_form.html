{% extends "base.html" %}

{% block title %}Make a Donation | Ceanapse{% endblock %}

{% block content %}
<section class="donation-section">
  <div class="donation-container">
    <div class="donation-header">
      <h1 class="donation-title">Make a Donation</h1>
      <p class="donation-subtitle">Support ocean conservation and make a difference today.</p>
    </div>

    <form class="donation-form" id="donation-form" method="POST" action="#">
      {% csrf_token %}
      
      <div class="form-group">
        <label for="donor_name" class="form-label">Full Name <span class="required">*</span></label>
        <input 
          type="text" 
          id="donor_name" 
          name="donor_name" 
          class="form-input" 
          placeholder="Enter your full name"
          required
          autocomplete="name"
        />
        <span class="form-error" id="name-error"></span>
      </div>

      <div class="form-group">
        <label for="donor_email" class="form-label">Email Address <span class="required">*</span></label>
        <input 
          type="email" 
          id="donor_email" 
          name="donor_email" 
          class="form-input" 
          placeholder="your.email@example.com"
          required
          autocomplete="email"
        />
        <span class="form-error" id="email-error"></span>
      </div>

      <div class="form-group">
        <label for="donor_phone" class="form-label">Phone Number <span class="required">*</span></label>
        <input 
          type="tel" 
          id="donor_phone" 
          name="donor_phone" 
          class="form-input" 
          placeholder="+254 700 000 000"
          required
          autocomplete="tel"
        />
        <span class="form-error" id="phone-error"></span>
      </div>

      <div class="form-group">
        <label for="amount" class="form-label">Donation Amount <span class="required">*</span></label>
        <div class="amount-input-wrapper">
          <span class="amount-currency">KES</span>
          <input 
            type="number" 
            id="amount" 
            name="amount" 
            class="form-input form-input--amount" 
            placeholder="0.00"
            min="1"
            step="0.01"
            required
          />
        </div>
        <span class="form-error" id="amount-error"></span>
        <div class="amount-suggestions">
          <button type="button" class="amount-btn" data-amount="500">KES 500</button>
          <button type="button" class="amount-btn" data-amount="1000">KES 1,000</button>
          <button type="button" class="amount-btn" data-amount="5000">KES 5,000</button>
          <button type="button" class="amount-btn" data-amount="10000">KES 10,000</button>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn--primary" id="submit-btn">
          <span class="btn-text">Proceed to Payment</span>
          <span class="btn-loader" id="btn-loader" style="display: none;">
            <span class="loader"></span>
          </span>
        </button>
        <a href="{% url 'donations:ocean_community' %}" class="btn btn--secondary">Cancel</a>
      </div>
    </form>
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
  // Amount suggestion buttons
  document.querySelectorAll('.amount-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const amount = this.getAttribute('data-amount');
      document.getElementById('amount').value = amount;
      
      // Update active state
      document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
    });
  });

  // Form validation
  const form = document.getElementById('donation-form');
  const submitBtn = document.getElementById('submit-btn');
  const btnLoader = document.getElementById('btn-loader');
  const btnText = submitBtn.querySelector('.btn-text');
// Helper function to get CSRF token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

//edits by team backend(Silas and Omondi) might tend to start from here... remember to update the documentation, /api/donations/initiate/
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Clear previous errors
    document.querySelectorAll('.form-error').forEach(err => err.textContent = '');
    document.querySelectorAll('.form-input').forEach(input => input.classList.remove('error'));

    // Get form values
    const name = document.getElementById('donor_name').value.trim();
    const email = document.getElementById('donor_email').value.trim();
    const phone = document.getElementById('donor_phone').value.trim();
    const amount = document.getElementById('amount').value;

    let hasErrors = false;

    // Validate name
    if (name.length < 2) {
      document.getElementById('name-error').textContent = 'Name must be at least 2 characters';
      document.getElementById('donor_name').classList.add('error');
      hasErrors = true;
    }

    // Validate email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      document.getElementById('email-error').textContent = 'Please enter a valid email address';
      document.getElementById('donor_email').classList.add('error');
      hasErrors = true;
    }

    // Validate phone
    const phoneRegex = /^[\+]?[0-9\s\-\(\)]+$/;
    if (!phoneRegex.test(phone) || phone.replace(/\D/g, '').length < 9) {
      document.getElementById('phone-error').textContent = 'Please enter a valid phone number';
      document.getElementById('donor_phone').classList.add('error');
      hasErrors = true;
    }

    // Validate amount
    const amountNum = parseFloat(amount);
    if (isNaN(amountNum) || amountNum < 1) {
      document.getElementById('amount-error').textContent = 'Amount must be at least KES 1';
      document.getElementById('amount').classList.add('error');
      hasErrors = true;
    }

    if (hasErrors) {
      return;
    }

    // Show loading state
    submitBtn.disabled = true;
    btnText.style.display = 'none';
    btnLoader.style.display = 'inline-block';

    try {
      // Submit to API endpoint
      const response = await fetch('/api/donations/initiate/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          donor_name: name,
          donor_email: email,
          donor_phone: phone,
          amount: amountNum
        })
      });

      const data = await response.json();

      if (data.status === 'success' && data.data && data.data.authorization_url) {
        // Redirect to Paystack payment page
        // Paystack will redirect back to callback_url configured in backend
        window.location.href = data.data.authorization_url;
      } else {
        // Handle API errors
        const errorMessage = data.message || 'An error occurred while processing your donation';
        
        // Display specific field errors if available
        if (data.errors) {
          Object.keys(data.errors).forEach(field => {
            const errorElement = document.getElementById(field + '-error');
            const inputElement = document.getElementById(field);
            if (errorElement && inputElement) {
              errorElement.textContent = data.errors[field][0] || 'Invalid value';
              inputElement.classList.add('error');
            }
          });
        } else {
          // Show general error message
          alert('Error: ' + errorMessage);
        }

        // Reset button state
        submitBtn.disabled = false;
        btnText.style.display = 'inline';
        btnLoader.style.display = 'none';
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Network error: Unable to connect to the server. Please check your connection and try again.');
      
      // Reset button state
      submitBtn.disabled = false;
      btnText.style.display = 'inline';
      btnLoader.style.display = 'none';
    }
  });

  // Real-time validation feedback
  document.querySelectorAll('.form-input').forEach(input => {
    input.addEventListener('blur', function() {
      const errorElement = document.getElementById(this.id + '-error');
      if (this.value.trim() && !this.classList.contains('error')) {
        this.classList.add('valid');
      }
    });

    input.addEventListener('input', function() {
      if (this.classList.contains('error') && this.value.trim()) {
        const errorElement = document.getElementById(this.id + '-error');
        if (errorElement) errorElement.textContent = '';
        this.classList.remove('error');
      }
    });
  });
</script>
{% endblock %}

